<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>2D fragment shader displaying video with ascii effect</title>
<script type="text/javascript" src="resources/webgl-utils.js"></script>
<script>
window.onload = setup;
    
function setup() 
{     
    canvas = document.getElementById("canvas");
    gl = getWebGLContext(canvas);
    if (!gl) 
    {
        alert("grrrr!");
        return;
    }

    // setup variables
    startTime = Date.now();    

    // setup GLSL program
    vertexShader = createShaderFromScriptElement(gl, "2d-vertex-shader");
    fragmentShader = createShaderFromScriptElement(gl, "2d-fragment-shader");
    program = createProgram(gl, [vertexShader, fragmentShader]);
    gl.useProgram(program);

    // look up attribute and uniform locations
    uniformLocations = {position:0, resolution:0, time:0};
    uniformLocations.position = gl.getAttribLocation(program, "pos");
    uniformLocations.resolution = gl.getUniformLocation(program, "resolution");
    uniformLocations.time = gl.getUniformLocation(program, "time");

    // Create a buffer and put a single clipspace rectangle in it (2 triangles)
    var buffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1.0,-1.0,1.0,-1.0,-1.0,1.0,-1.0,1.0,1.0,-1.0,1.0,1.0]), gl.STATIC_DRAW);
    gl.enableVertexAttribArray(uniformLocations.position);
    gl.vertexAttribPointer(uniformLocations.position, 2, gl.FLOAT, false, 0, 0);
    
    // create texture
    media = document.getElementById('media');

    texture = gl.createTexture();
    gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
    gl.bindTexture(gl.TEXTURE_2D,  texture);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE );
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE );

    render();
}
    
function refreshTexture()
{
    gl.bindTexture(gl.TEXTURE_2D, texture);
    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, media);
}


function render()
{
	requestAnimationFrame(render);
	
    var time = Date.now() - startTime;
    
    gl.useProgram(program);
    
    gl.activeTexture(gl.TEXTURE0);
    refreshTexture();

    gl.uniform2f(uniformLocations.resolution, canvas.width, canvas.height);
    gl.uniform1f(uniformLocations.time, time/1000);

    // draw
    gl.drawArrays(gl.TRIANGLES, 0, 6);
}
    
</script>
<!-- vertex shader -->
<script id="2d-vertex-shader" type="x-shader/x-vertex">
attribute vec2 pos;
uniform vec2 resolution;

void main() {
    gl_Position = vec4(pos, 0, 1);
}
</script>
<!-- fragment shader -->
<script id="2d-fragment-shader" type="x-shader/x-fragment">
precision highp float;
uniform sampler2D media;
uniform float time;
uniform vec2 resolution;

float character(float n, vec2 p)
{
	p = floor(p*vec2(4.0, -4.0) + 2.5);
    if (clamp(p.x, 0.0, 4.0) == p.x)
	{
        if (clamp(p.y, 0.0, 4.0) == p.y)	
		{
            if (int(mod(n/exp2(p.x + 5.0*p.y), 2.0)) == 1) return 1.0;
		}	
    }
	return 0.0;
}

void main()
{
    vec2 p = gl_FragCoord.xy;
	vec2 uv = p / resolution.xy;

    vec3 col = texture2D(media, uv).rgb;

	float gray = 0.3 * col.r + 0.59 * col.g + 0.11 * col.b;
	
	float n =  4096.0;              // .
	if (gray > 0.2) n = 65600.0;    // :
	if (gray > 0.3) n = 332772.0;   // *
	if (gray > 0.4) n = 15255086.0; // o 
	if (gray > 0.5) n = 23385164.0; // &
	if (gray > 0.6) n = 15252014.0; // 8
	if (gray > 0.7) n = 13199452.0; // @
	if (gray > 0.8) n = 11512810.0; // #
	
	p = mod(p/4.0, 2.0) - vec2(1.0);
    col = col*character(n, p);
	
	gl_FragColor = vec4(col, 1.0);
}

</script>
<style>
    
html, body {
  background-color: #aaa;
  font-family: Sans-Serif;
}

canvas {
  background-color: #fff;
  border: 1px solid black;
}

.hidden { /* don't use display:none or visibility:hidden because that will prevent safari from playing the video */
    width:1px; 
    height:1px; 
    opacity:0;
}

</style>
</head>
<body>
    <canvas id="canvas" width="800" height="800"></canvas>
    <video id="media" src="resources/video.mp4" muted autoplay class="hidden"></video>
</body>
</html>

